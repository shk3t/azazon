apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-database-config
  namespace: {{ .Release.Namespace }}
data:
  postgresql_master.conf: |
    data_directory = '/data/pgdata'
    hba_file = '/config/pg_hba.conf'
    ident_file = '/config/pg_ident.conf'

    port = {{ .Values.db.port }}
    listen_addresses = '*'

    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 10

    archive_mode = on
    archive_command = 'test ! -f /data/archive/%f && cp %p /data/archive/%f'

  postgresql_slave.conf: |
    data_directory = '/data/pgdata'
    hba_file = '/config/pg_hba.conf'
    ident_file = '/config/pg_ident.conf'

    port = {{ .Values.db.port }}
    listen_addresses = '*'

  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    host    all             all             10.244.0.0/16           md5
    host    replication     shket2          10.244.0.0/16           md5
    # "local" is for Unix domain socket connections only
    local   all             all                                     trust
    # IPv4 local connections:
    host    all             all             127.0.0.1/32            trust
    # IPv6 local connections:
    host    all             all             ::1/128                 trust
    # Allow replication connections from localhost, by a user with the
    # replication privilege.
    local   replication     all                                     trust
    host    replication     all             127.0.0.1/32            trust
    host    replication     all             ::1/128                 trust

  setup.sh: |
    cp /config-init/* /config

    if [[ $HOSTNAME == *database*-0 ]]; then
        cp /config/postgresql_master.conf /config/postgresql.conf

        mkdir -p /data/archive
        chown -R postgres:postgres /data/archive

        echo "CREATE USER ${REPLICA_USER} REPLICATION LOGIN ENCRYPTED PASSWORD '${REPLICA_PASSWORD}';" > \
            /docker-entrypoint-initdb.d/init.sql
    else
        cp /config/postgresql_slave.conf /config/postgresql.conf

        if [[ ! -d "${PGDATA}" ]]; then
            mkdir -p $PGDATA
            chmod 700 $PGDATA
            chown postgres:root $PGDATA
        fi
        if [[ -z "$(ls -A ${PGDATA})" ]]; then
            export PGPASSWORD=${REPLICA_PASSWORD}
            pg_basebackup -h "{{ .Values.app.name }}-database-statefulset-0.{{ .Values.app.name }}-database-service" -U ${REPLICA_USER} -D ${PGDATA} -Fp -Xs -R
        fi
    fi

